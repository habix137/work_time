<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Persian Work Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        body{padding:20px;background:#f8f9fa}
        .card{margin-bottom:20px}
        .progress{height:20px}
        .alert-dismissible{position:fixed;top:20px;right:20px;z-index:1000}
        .nav-tabs{margin-bottom:20px}
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Work Time Tracker</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endwith %}

    <!-- Tabs -->
    <ul class="nav nav-tabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#work-log">Work Log</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#set-goal">Set Goal</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#todo">To-Do List</a></li>
    </ul>

    <div class="tab-content">
    <!-- ───────────────────────  Work-Log tab  ─────────────────────── -->
    <div class="tab-pane fade show active" id="work-log">
        <div class="card mb-4"><div class="card-body">
            <h2 class="card-title">Today</h2>
            <p><strong>Date (Persian):</strong> {{ today_persian }}</p>
            <p><strong>Time:</strong> <span id="current-time"></span></p>
        </div></div>

        <!-- Log hours form -->
        <div class="card mb-4"><div class="card-body">
            <h2>Log Work Hours</h2>
            <form action="{{ url_for('log_work') }}" method="post">
                <div class="mb-3">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-control" name="company" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Hours</label>
                    <input type="number" class="form-control" step="0.1" min="0.1" name="hours" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" name="description">
                </div>
                <div class="mb-3">
                    <label class="form-label">Date (Persian)</label>
                    <input type="text" class="form-control flatpickr" name="date" placeholder="Leave blank for today">
                </div>
                <button class="btn btn-primary">Log Hours</button>
            </form>
        </div></div>

        <!-- Progress for each company -->
        <h2 class="mt-4">Progress</h2>
        {% for company, info in data.items() %}
        <div class="card mb-3"><div class="card-body">
            <h3>{{ company }}</h3>
            <p>Goal: {{ info.goal|round(1) }} h</p>
            <p>Total Logged: {{ info.total_hours }} h</p>
            <p>Remaining: {{ info.remaining_hours|round(1) }} h</p>

            {% if info.goal > 0 %}
              <div class="progress mb-3">
                  <div class="progress-bar bg-success"
                       style="width: {{ info.progress if info.progress <= 100 else 100 }}%"
                       aria-valuenow="{{ info.progress }}" aria-valuemin="0" aria-valuemax="100">
                      {{ info.progress }}%
                  </div>
              </div>
            {% else %}
              <p><em>No goal set.</em></p>
            {% endif %}

            {% if info.recommended_hours %}
              <p>Recommended: {{ info.recommended_hours }} h/day
                 ({{ info.remaining_days }} work-days left{{ ' until ' ~ info.deadline if info.deadline else '' }})</p>
              <p>Work schedule: {{ info.workdays_count }} days/week</p>
            {% elif info.goal and info.remaining_days == 0 %}
              <p><strong>Deadline passed — no workdays left.</strong></p>
            {% endif %}

            <!-- Logs -->
            <h4>Logs</h4>
            <ul class="list-group mb-3">
                {% for date, entry in info.log.items() %}
                  {% set hours = entry.hours if entry is mapping else entry %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                      {{ date }}: {{ hours|round(1) }} h
                      {% if entry.description %}&ndash; {{ entry.description }}{% endif %}
                      <a class="btn btn-sm btn-danger"
                         href="{{ url_for('delete_log', company=company, date=date) }}"
                         onclick="return confirm('Delete this log?')">Delete</a>
                  </li>
                {% endfor %}
            </ul>
        </div></div>
        {% endfor %}
    </div>

    <!-- ───────────────────────  Set Goal tab  ─────────────────────── -->
    <div class="tab-pane fade" id="set-goal">
        <div class="card"><div class="card-body">
            <h2 class="card-title">Set Work Goal</h2>
            <form action="{{ url_for('set_goal') }}" method="post">
                <div class="mb-3">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-control" name="company" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Goal Hours</label>
                    <input type="number" class="form-control" step="1" min="0" name="goal" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Workdays per Week (0-7)</label>
                    <input type="number" class="form-control" name="workdays_count" min="0" max="7" value="5" required>
                    <small class="text-muted">0 = no days, 7 = every day</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Deadline (Persian)</label>
                    <input type="text" class="form-control flatpickr" name="deadline" placeholder="Leave blank = end of month">
                </div>
                <button class="btn btn-primary">Set Goal</button>
            </form>

            <h3 class="mt-4">Current Goals</h3>
            {% for company, info in data.items() if info.goal %}
            <div class="card mb-3">
                <div class="card-body">
                    <h4>{{ company }}</h4>
                    <p><strong>Goal:</strong> {{ info.goal|round(1) }} hours</p>
                    <p><strong>Work Schedule:</strong> {{ info.workdays_count }} days/week</p>
                    {% if info.deadline %}
                    <p><strong>Deadline:</strong> {{ info.deadline }}</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p>No goals set yet.</p>
            {% endfor %}
        </div></div>
    </div>

    <!-- ───────────────────────  To-Do tab  ─────────────────────── -->
    <div class="tab-pane fade" id="todo">
        <div class="card"><div class="card-body">
            <h2 class="card-title">To-Do List</h2>
            <form action="{{ url_for('add_task') }}" method="post">
                <div class="mb-3">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-control" name="company" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-control" name="task_title" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Date (Persian)</label>
                    <input type="text" class="form-control flatpickr" name="task_date" placeholder="Leave blank = today">
                </div>
                <button class="btn btn-primary">Add Task</button>
            </form>

            <h3 class="mt-4">Tasks</h3>
            {% for company, info in data.items() if info.tasks %}
              <h4>{{ company }}</h4>
              <ul class="list-group mb-3">
                {% for task in info.tasks %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                      <form action="{{ url_for('update_task', company=company, task_id=task.id) }}"
                            method="post" class="d-flex align-items-center">
                          <input type="checkbox" name="completed" class="form-check-input me-2"
                                 {% if task.completed %}checked{% endif %}
                                 onchange="this.form.submit()">
                          <span{% if task.completed %} style="text-decoration: line-through"{% endif %}>
                              {{ task.date }} – {{ task.title }}
                          </span>
                      </form>
                      <a class="btn btn-sm btn-danger"
                         href="{{ url_for('delete_task', company=company, task_id=task.id) }}"
                         onclick="return confirm('Delete this task?')">Delete</a>
                  </li>
                {% endfor %}
              </ul>
            {% endfor %}
        </div></div>
    </div>
    </div><!-- /tab-content -->
</div><!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    flatpickr('.flatpickr', {dateFormat: 'Y-m-d', defaultDate: '{{ today_persian }}'});
    function updateTime(){
        const n=new Date();
        document.getElementById('current-time').textContent =
            n.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }
    updateTime(); setInterval(updateTime,1000);
});
</script>
</body>
</html>