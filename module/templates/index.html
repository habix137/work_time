<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Work Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background: #f8f9fa; }
    .card { margin-bottom: 20px; }
    .alert-dismissible { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Work Tracker (Persian Calendar)</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endwith %}

  <!-- Two Tabs only: Track + Report -->
  <ul class="nav nav-tabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#track">Track</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#report">Report</a></li>
  </ul>

  <div class="tab-content">
    <!-- TRACK TAB -->
    <div class="tab-pane fade show active" id="track">
      <div class="row">
        <div class="col-lg-7">
          <div class="card">
            <div class="card-body">
              <h2 class="card-title">Time Tracker</h2>
              <p class="mb-1"><strong>Date (Persian):</strong> {{ today_persian }}</p>
              <p class="mb-3"><strong>Time:</strong> <span id="current-time"></span></p>

              <div class="mb-3">
                <label class="form-label">Project</label>
                <select id="project-select" class="form-select">
                  <option value="">Select a project</option>
                  {% for project_name in projects.keys() %}
                    <option value="{{ project_name }}">{{ project_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="d-flex gap-3 mb-3">
                <button id="start-btn" class="btn btn-primary">Start Work</button>
                <button id="end-btn" class="btn btn-danger" disabled>Stop Work</button>
              </div>

              <div id="session-info" class="alert alert-info" style="display:none"></div>

              <hr>

              <h5>Last Time Log</h5>
              <div id="last-log-info" class="alert alert-secondary" style="display:none">
                Select a project to see the last time log
              </div>

              <h5 class="mt-4">Today's Work Sessions</h5>
              <ul id="today-sessions" class="list-group mb-3"></ul>
              <div id="today-total" class="alert alert-success" style="display:none"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h3>All Time Logs</h3>
              <div id="time-logs" class="list-group">
                {% set any_logs = false %}
                {% for project_name, project in projects.items() %}
                  {% if project.time_logs %}
                    {% set any_logs = true %}
                    <div class="list-group-item">
                      <h5>{{ project_name }} <small>(Tags: {{ project.tags|join(', ') if project.tags else '—' }})</small></h5>
                      <ul class="list-group">
                        {% for log in project.time_logs %}
                          <li class="list-group-item d-flex justify-content-between">
                            <span>{{ log.date }}: {{ log.start_time }} - {{ log.end_time }} ({{ log.duration }} hours)</span>
                            <a href="#" class="btn btn-sm btn-danger delete-time-log"
                               data-project="{{ project_name }}"
                               data-date="{{ log.date }}"
                               data-start="{{ log.start_time }}">Delete</a>
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                {% endfor %}
                {% if not any_logs %}
                  <p class="mt-2">No time logs recorded yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="card">
            <div class="card-body">
              <h2 class="card-title">Projects</h2>

              <!-- Add project -->
              <form action="{{ url_for('add_project') }}" method="post" class="mb-4">
                <div class="mb-3">
                  <label class="form-label">Project Name</label>
                  <input type="text" class="form-control" name="name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Tags (comma-separated)</label>
                  <input type="text" class="form-control" name="tags" placeholder="e.g., MyCompany, Development">
                </div>
                <button class="btn btn-primary">Add Project</button>
              </form>

              <!-- List/manage projects -->
              {% for project_name, project in projects.items() %}
                <div class="border rounded p-3 mb-3 bg-white">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h5 class="mb-1">{{ project_name }}</h5>
                      <div class="small text-muted">Tags: {{ project.tags|join(', ') if project.tags else '—' }}</div>
                      {% if today_logs.get(project_name) %}
                        <div class="mt-1"><strong>Today's Total:</strong> {{ today_logs[project_name]|sum(attribute='duration')|round(2) }} hours</div>
                      {% endif %}
                    </div>
                    <div class="ms-3">
                      <form action="{{ url_for('reset_project') }}" method="post" style="display:inline" onsubmit="return confirm('Reset all logs for this project?');">
                        <input type="hidden" name="project" value="{{ project_name }}">
                        <button type="submit" class="btn btn-warning btn-sm me-1">Reset Logs</button>
                      </form>
                      <a class="btn btn-danger btn-sm" href="{{ url_for('delete_project', project_name=project_name) }}" onclick="return confirm('Delete this project?')">Delete</a>
                    </div>
                  </div>
                  <form action="{{ url_for('update_project') }}" method="post" class="mt-2">
                    <input type="hidden" name="project" value="{{ project_name }}">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">Tags</span>
                      <input type="text" class="form-control" name="tags" value="{{ project.tags|join(', ') if project.tags else '' }}" placeholder="comma,separated">
                      <button class="btn btn-outline-primary">Save</button>
                    </div>
                  </form>
                </div>
              {% else %}
                <p>No projects yet. Add one above.</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div><!-- /row -->
    </div>

    <!-- REPORT TAB -->
    <div class="tab-pane fade" id="report">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">Report</h2>
          <form method="get" action="{{ url_for('report') }}" class="mb-3">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Project</label>
                <select name="project" class="form-select">
                  <option value="">All Projects</option>
                  {% for project_name in projects.keys() %}
                    <option value="{{ project_name }}">{{ project_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Tag</label>
                <input type="text" name="tag" class="form-control" placeholder="e.g., MyCompany">
              </div>
              <div class="col-md-3">
                <label class="form-label">Date From</label>
                <input type="text" name="date_from" class="form-control flatpickr">
              </div>
              <div class="col-md-3">
                <label class="form-label">Date To</label>
                <input type="text" name="date_to" class="form-control flatpickr">
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-2">Open Report</button>
            <a href="{{ url_for('report') }}" class="btn btn-secondary mt-2">Open Empty Report</a>
          </form>
          <p class="text-muted mb-0">Report opens in a separate page where you can copy or download Markdown.</p>
        </div>
      </div>
    </div>
  </div><!-- /tab-content -->
</div><!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  flatpickr('.flatpickr', {dateFormat: 'Y-m-d', defaultDate: '{{ today_persian }}'});

  function updateTime(){
    const n = new Date();
    document.getElementById('current-time').textContent =
      n.toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
  }
  updateTime(); setInterval(updateTime, 1000);

  // Time Tracking Functionality
  const startBtn = document.getElementById('start-btn');
  const endBtn = document.getElementById('end-btn');
  const projectSelect = document.getElementById('project-select');
  const sessionInfo = document.getElementById('session-info');
  const todaySessions = document.getElementById('today-sessions');
  const todayTotal = document.getElementById('today-total');
  const lastLogInfo = document.getElementById('last-log-info');
  let currentSession = null;

  function loadTodaySessions() {
    fetch('/get_today_time_logs')
      .then(res => res.json())
      .then(data => {
        todaySessions.innerHTML = '';
        let totalHours = 0;
        if (data.logs && Object.keys(data.logs).length > 0) {
          for (const [project, logs] of Object.entries(data.logs)) {
            logs.forEach(log => {
              const li = document.createElement('li');
              li.className = 'list-group-item';
              li.innerHTML = `<strong>${project}</strong>: ${log.start_time} - ${log.end_time} (${log.duration} hours)`;
              todaySessions.appendChild(li);
              totalHours += parseFloat(log.duration);
            });
          }
          todayTotal.style.display = 'block';
          todayTotal.textContent = `Total today: ${totalHours.toFixed(2)} hours`;
        } else {
          todaySessions.innerHTML = '<li class="list-group-item">No sessions today</li>';
          todayTotal.style.display = 'none';
        }
      });
  }

  function loadLastTimeLog(project) {
    if (!project) { lastLogInfo.style.display = 'none'; return; }
    fetch(`/get_last_time_log?project=${encodeURIComponent(project)}`)
      .then(res => res.json())
      .then(data => {
        lastLogInfo.style.display = 'block';
        if (data.status === 'success') {
          lastLogInfo.textContent = `Last log for ${project}: ${data.last_log.date} ${data.last_log.start_time} - ${data.last_log.end_time} (${data.last_log.duration} hours)`;
        } else {
          lastLogInfo.textContent = `No time logs for ${project}`;
        }
      });
  }

  function checkCurrentSession() {
    const project = projectSelect.value;
    if (!project) return;
    fetch(`/get_current_session?project=${encodeURIComponent(project)}`)
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          currentSession = { project, startTime: new Date(data.current_session.start_time) };
          startBtn.disabled = true;
          endBtn.disabled = true; // enable only after 2 seconds to avoid double-clicks
          setTimeout(() => endBtn.disabled = false, 2000);
          projectSelect.disabled = true;
          sessionInfo.style.display = 'block';
          sessionInfo.textContent = `Session started at ${currentSession.startTime.toLocaleTimeString()}`;
        } else {
          currentSession = null;
          startBtn.disabled = false;
          endBtn.disabled = true;
          projectSelect.disabled = false;
          sessionInfo.style.display = 'none';
        }
      });
  }

  // Delete time log
  document.querySelectorAll('.delete-time-log').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      if (confirm('Delete this time log?')) {
        const project = this.dataset.project;
        const date = this.dataset.date;
        const startTime = this.dataset.start;
        fetch('/delete_time_log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `project=${encodeURIComponent(project)}&date=${encodeURIComponent(date)}&start_time=${encodeURIComponent(startTime)}`
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            this.closest('li').remove();
            loadTodaySessions();
            if (projectSelect.value === project) loadLastTimeLog(project);
          }
        });
      }
    });
  });

  // Start session
  startBtn.addEventListener('click', () => {
    const project = projectSelect.value;
    if (!project) { alert('Please select a project'); return; }
    fetch('/start_time_log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `project=${encodeURIComponent(project)}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        currentSession = { project, startTime: new Date(data.start_time) };
        startBtn.disabled = true;
        endBtn.disabled = false;
        projectSelect.disabled = true;
        sessionInfo.style.display = 'block';
        sessionInfo.textContent = `Session started at ${currentSession.startTime.toLocaleTimeString()}`;
      } else {
        alert(data.message || 'Failed to start session');
      }
    });
  });

  // End session
  endBtn.addEventListener('click', () => {
    if (!currentSession) { alert('No active session'); return; }
    const project = currentSession.project;
    fetch('/end_time_log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `project=${encodeURIComponent(project)}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        startBtn.disabled = false;
        endBtn.disabled = true;
        projectSelect.disabled = false;
        sessionInfo.style.display = 'block';
        sessionInfo.textContent = `Session ended. Duration: ${data.duration} hours`;
        currentSession = null;
        loadTodaySessions();
        loadLastTimeLog(project);
      } else {
        alert(data.message || 'Failed to end session');
      }
    });
  });

  // When project changes
  projectSelect.addEventListener('change', () => {
    loadLastTimeLog(projectSelect.value);
    checkCurrentSession();
  });

  // Initial data
  loadTodaySessions();
});
</script>
</body>
</html>
